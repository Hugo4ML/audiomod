<!DOCTYPE html>
<html>
  <head>
    <title>Loop audio file(4)</title>
  </head>
  <body>
    <input type = "file" id = "file"></input>
    <button onclick='window.document.getElementById("header1").innerHTML = "loopAudio call state";'>Reset header</button>
    <button onclick='loopAudio();'>Concat audio!</button>
    <h1 id = 'header1'>Header</h1>
    <h2 id = 'header2'>Header</h2>
    <script>
      window.document.getElementById("header1").innerHTML = "loopAudio call state"
      async function loopAudio() {
        /*
        Generates new audio by concatenating original to itself until it passes the specified lenght in time.
        */
        window.document.getElementById("header1").innerHTML = "loopAudio called"; //Confirms function call.
        const file = window.document.getElementById("file").files[0], name = file.name, extension = name.substring(name.lastIndexOf('.') + 1, name.length) || name;
        window.document.getElementById("header1").innerHTML = "loopAudio ready to be called"; //Confirms function call.
        const fileReader = new FileReader();
        fileReader.onload = (event) => {
          /*
          Read file audio data.
          */
          let blob = new Blob([], {type: "audio/" + extension}), url = URL.createObjectURL(blob);
          const base = event.target.result, blobReader = new FileReader(), audio = new Audio();
          blobReader.onload = (event) => {
            window.document.getElementById("header1").innerHTML = "Blob loaded."; //Confirms function call.
            blob = new Blob([base, event.target.result], {type: "audio/" + extension});
            url = URL.createObjectURL(blob);
            audio.src = url;
            window.document.getElementById("header1").innerHTML = "Source changed."; //Confirms function call.
          }
          audio.onloadedmetadata = () => {
            /*
            Obtain audio duration and determine if a new blob should be created.
            */
            window.document.getElementById("header1").innerHTML = "Audio metadata called."; //Confirms function call.
            if(/*audio.duration > 12.5 * 3600*/true) {
              const link = window.document.createElement("a");
              link.href = url;
              link.download = "DOWNLOAD." + extension;
              link.click();
            } else {
              blobReader.readAsArrayBuffer(blob);
            }          
            window.document.getElementById("header1").innerHTML = "Completion."; //Confirms function call.
          }
          audio.src = url;
          window.document.getElementById("header1").innerHTML = "loopAudio has been called"; //Confirms function call.
          //audio.onloadedmetadata = async => {
            /*
            Generate new audio from file information.
            */
            /*const data = new Array(Math.trunc((12.5 * 3600) / audio.duration) + 1);
            let msg = "";
            for(let index = 0; index < data.length; ++index) data[index] = event.target.result;
            for(let index = 0; index < data.length; ++index) {
              if(data[index] == event.target.result) {
                msg += 1;
              } else {
                msg += 0;
              }
            }
            const nblob = new Blob(data, {type: "audio/" + extension}), url = URL.createObjectURL(nblob);
            
            blob = new Blob([blob.arrayBuffer(), blob.arrayBuffer(), blob.arrayBuffer(), event.target.result], {type: "audio/" + extension});*/
            //audio.src = URL.createObjectURL(blob);
            /* else {
              const link = document.createElement("a");
              link.href = URL.createObjectURL(blob);
              link.download = "download." + extension;
              link.click();
            }*/
            /*let link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "download." + extension;
            link.click();
          }*/
        }
        fileReader.readAsArrayBuffer(file);
      }
    </script>
  </body>
</html>
